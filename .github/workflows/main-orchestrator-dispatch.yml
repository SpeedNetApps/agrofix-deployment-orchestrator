name: Deployment Orchestrator

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to deploy (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ui
          - api
          - dashboard
          - submission
          - gateway
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "orchestrate"
  orchestrate:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Run a one-line script
      - name: Log deployment parameters
        run: |
          echo "ðŸš€ Deployment Orchestrator Starting"
          echo "Component: ${{ github.event.inputs.component || 'Not specified' }}"
          echo "Environment: ${{ github.event.inputs.environment || 'Not specified' }}"
          echo "Triggered by: ${{ github.actor }}"

      # Trigger UI deployment
      - name: Trigger BusinessProposalEvaluator.UI Deployment
        if: ${{ github.event.inputs.component == 'ui' || github.event.inputs.component == 'all' }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.ORCHESTRATOR_PAT }}" \
            https://api.github.com/repos/snlinfo2/BusinessProposalEvaluator.UI/dispatches \
            -d '{
              "event_type": "deploy-signal",
              "client_payload": {
                "environment": "${{ github.event.inputs.environment }}",
                "component": "ui",
                "triggered_by": "${{ github.actor }}",
                "run_id": "${{ github.run_id }}"
              }
            }'
          echo "âœ… Triggered UI deployment to BusinessProposalEvaluator.UI repository"

      # Trigger LVT API deployment
      - name: Trigger Lvtapp_uas API Deployment
        if: ${{ github.event.inputs.component == 'api' || github.event.inputs.component == 'all' }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.ORCHESTRATOR_PAT }}" \
            https://api.github.com/repos/snlinfo2/Lvtapp_uas/dispatches \
            -d '{
              "event_type": "deploy-signal",
              "client_payload": {
                "environment": "${{ github.event.inputs.environment }}",
                "component": "api",
                "triggered_by": "${{ github.actor }}",
                "run_id": "${{ github.run_id }}"
              }
            }'
          echo "âœ… Triggered API deployment to Lvtapp_uas repository"

      # Trigger Dashboard API deployment
      - name: Trigger lvtapp_dashbs Dashboard API Deployment
        if: ${{ github.event.inputs.component == 'dashboard' || github.event.inputs.component == 'all' }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.ORCHESTRATOR_PAT }}" \
            https://api.github.com/repos/snlinfo2/lvtapp_dashbs/dispatches \
            -d '{
              "event_type": "deploy-signal",
              "client_payload": {
                "environment": "${{ github.event.inputs.environment }}",
                "component": "dashboard",
                "triggered_by": "${{ github.actor }}",
                "run_id": "${{ github.run_id }}"
              }
            }'
          echo "âœ… Triggered Dashboard API deployment to lvtapp_dashbs repository"

      # Trigger Submission Service deployment
      - name: Trigger Lvtapp_BProposalSubmissionService Deployment
        if: ${{ github.event.inputs.component == 'submission' || github.event.inputs.component == 'all' }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.ORCHESTRATOR_PAT }}" \
            https://api.github.com/repos/snlinfo2/Lvtapp_BProposalSubmissionService/dispatches \
            -d '{
              "event_type": "deploy-signal",
              "client_payload": {
                "environment": "${{ github.event.inputs.environment }}",
                "component": "submission",
                "triggered_by": "${{ github.actor }}",
                "run_id": "${{ github.run_id }}"
              }
            }'
          echo "âœ… Triggered Submission Service deployment to Lvtapp_BProposalSubmissionService repository"

      # Trigger Gateway/OCELOT Server deployment
      - name: Trigger lvt-ocelot-server-service Deployment
        if: ${{ github.event.inputs.component == 'gateway' || github.event.inputs.component == 'all' }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.ORCHESTRATOR_PAT }}" \
            https://api.github.com/repos/snlinfo2/lvt-ocelot-server-service/dispatches \
            -d '{
              "event_type": "deploy-signal",
              "client_payload": {
                "environment": "${{ github.event.inputs.environment }}",
                "component": "gateway",
                "triggered_by": "${{ github.actor }}",
                "run_id": "${{ github.run_id }}"
              }
            }'
          echo "âœ… Triggered Gateway deployment to lvt-ocelot-server-service repository"

      # Runs a multi-line script for completion
      - name: Deployment Orchestration Complete
        run: |
          echo "ðŸŽ‰ Deployment orchestration completed!"
          echo "Components triggered: ${{ github.event.inputs.component }}"
          echo "Target environment: ${{ github.event.inputs.environment }}"
          echo ""
          echo "Target repositories:"
          echo "-------------------"
          ${{ github.event.inputs.component == 'ui' || github.event.inputs.component == 'all' }} && echo "â€¢ BusinessProposalEvaluator.UI (UI)"
          ${{ github.event.inputs.component == 'api' || github.event.inputs.component == 'all' }} && echo "â€¢ Lvtapp_uas (API)"
          ${{ github.event.inputs.component == 'dashboard' || github.event.inputs.component == 'all' }} && echo "â€¢ lvtapp_dashbs (Dashboard API)"
          ${{ github.event.inputs.component == 'submission' || github.event.inputs.component == 'all' }} && echo "â€¢ Lvtapp_BProposalSubmissionService (Submission Service)"
          ${{ github.event.inputs.component == 'gateway' || github.event.inputs.component == 'all' }} && echo "â€¢ lvt-ocelot-server-service (Gateway)"
          echo ""
          echo "Check each repository's Actions tab for deployment status."
